/*----------------------------------------------------------------------------------------------------------*/
/*–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–æ—Ç–∞ –∫ —Å–æ–æ–±—â–µ—Å—Ç–≤—É:*/
/*----------------------------------------------------------------------------------------------------------*/
const token_group = ""; // —Ç–æ–∫–µ–Ω –≥—Ä—É–ø–ø—ã
const token_admin = ""; // —Ç–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≥—Ä—É–ø–ø—ã
let cgroup = 204671289; // id –≥—Ä—É–ø–ø—ã
const admins = [144793398, 370553427]; // id –∞–¥–º–∏–Ω–æ–≤ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
const chatId = 1; // ID –≥–ª–∞–≤–Ω–æ–π –±–µ—Å–µ–¥—ã (–∞–¥–º–∏–Ω–æ–≤)

const { VK } = require('vk-io');
const vk = new VK({
    token: token_group,
    lang: "ru",
    pollingGroupId: cgroup,
    apiMode: "parallel"
});
const page = new VK({ token: token_admin });

const { updates } = vk;
const db = require("./modules/MongoConnect"); // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–ê–ó–ï –î–ê–ù–ù–´–•!
const utils = require("./modules/utils"); // –î–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∫ –±–æ—Ç—É [–ö—Ä–∞—Å–∏–í—ã–µ –¥–µ–Ω—å–≥–∏, ID –∏–≥—Ä–æ–∫–∞ –∏ –¥—Ä.]
const user = require("./modules/ProfileConnect"); // –ü—Ä–æ—Ñ–∏–ª–∏ –∏–≥—Ä–æ–∫–æ–≤/–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è!
const group = require("./modules/ProfileConnect"); // –ü—Ä–æ—Ñ–∏–ª–∏ –∏–≥—Ä–æ–∫–æ–≤/–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è!
const request = require("request"); // –ó–∞–ø—Ä–æ—Å—ã –∫ —Å–∞–π—Ç–∞–º!
const { vkId } = require('./modules/utils');

/*----------------------------------------------------------------------------------------------------------*/
/*–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:*/
/*----------------------------------------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------------------------------------*/
/*–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:*/
/*----------------------------------------------------------------------------------------------------------*/
console.log("–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!"); // –°–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å
/*----------------------------------------------------------------------------------------------------------*/

updates.startPolling();
updates.on('message', async(msg, next) => {
    if (msg.senderId < 0) return; // –ò–≥–Ω–æ—Ä –µ—Å–ª–∏ –ø–∏—à–µ—Ç –≥—Ä—É–ø–ø–∞!

    // let NewUser = await db().collection("admins").findOne({ vk: msg.senderId });
    // msg.user = await user(msg.senderId); // –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –∏–≥—Ä–æ–∫–æ–º!

    // if (!NewUser) {
    //     if (!msg.isChat) return msg.send(`üî• —É –í–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–∏–º –±–æ—Ç–æ–º \n –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ @id${ownerId}`);
    // }

    msg.original = msg.text // –¢–∞–∫ –Ω–∞–¥–æ :D
    msg.params_org = msg.original.split(" "); // –¢–∞–∫ –Ω–∞–¥–æ :D
    msg.params_org.shift(); // –¢–∞–∫ –Ω–∞–¥–æ :D
    msg.params = msg.text.split(" "); // –¢–∞–∫ –Ω–∞–¥–æ :D
    msg.params.shift(); // –¢–∞–∫ –Ω–∞–¥–æ :D
    msg.params_alt = msg.text.split(" "); // –¢–∞–∫ –Ω–∞–¥–æ :D

    await next(); // –¢–∞–∫ –Ω–∞–¥–æ :/
});


//////////////////////////////////////////////////////////////////////
/*-------------------------------------------------------------------*/
/*     |                   –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã                   
/*-------------------------------------------------------------------*/
setInterval(() => {
    utils.getFrauds(page, cgroup);
    utils.checkConversations(page, vk, cgroup);
}, 600000);

/*-------------------------------------------------------------------*/
/*     |                   –ö–æ–º–∞–Ω–¥—ã                   
/*-------------------------------------------------------------------*/

//–ê–¥–º–∏–Ω–∫–∞
updates.hear(/^(updatedb)/ig, async(msg) => {
    await db().collection('data').updateMany({}, {
        $set: {}
    });
});

/*-------------------------------------------------------------------*/
/*     |                   –î–ª—è –∞–¥–º–∏–Ω–æ–≤ –±–µ—Å–µ–¥—ã:                   
/*-------------------------------------------------------------------*/
updates.hear(/^([–∞–æ]—Å—Ç–∞–≤[–µ–∏]—Ç—å)/ig, async(msg) => {
    if (!msg.chatId) return msg.send(`–ö–æ–≥–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ? –ö–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –±–µ—Å–µ–¥–µ üëÄ`);

    let peerId = Number(msg.peerId - 2000000000); // id –±–µ—Å–µ–¥—ã –≤ –∫–æ—Ç–æ—Ä–æ–π –≤—ã–∑–≤–∞–ª–∞—Å—å –∫–æ–º–∞–Ω–¥–∞
    page.api.messages.getConversationMembers({
        peer_id: 2000000000 + peerId,
        group_id: cgroup
    }).then(async function(a) {
        for (let i = 0; i < a.count; i++) {
            if (a.items[i].member_id == msg.senderId) { // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω –≤ –±–µ—Å–µ–¥–µ —Ç–æ —Ä–∞–±–æ—Ç–∞–µ–º –¥–∞–ª—å—à–µ
                if (!msg.params_org[0]) return msg.send(`–ü—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Å—Ç–∞–≤–∏—Ç—å`);
                let id = await vkId(msg.params_org[0], vk); // –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –∫–æ—Ç–æ—Ä–æ–≥–æ –≤–≤–µ–ª–∏
                let t = await user(id);


                // –¥–æ–±–∞–≤–ª—è–µ–º –≤ –±–∞–∑—É ID –±–µ—Å–µ–¥—ã –∫–∞–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
                let exception = t.exception;
                if (exception.includes(peerId)) return msg.send(`–í—ã —É–∂–µ –¥–æ–±–∞–≤–∏–ª–∏ –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–π –±–µ—Å–µ–¥—ã ‚ùó`);
                exception.push(peerId);
                t.exception = exception;

                // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –≥–ª–∞–≤–Ω—É—é –±–µ—Å–µ–¥—É:
                vk.api.messages.send({
                    chat_id: chatId,
                    message: `‚ö† @id${t.vk} –î–∞–Ω–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –æ—Å—Ç–∞–≤–∏–ª–∏, –∫–∞–∫ –Ω–µ —Å–ª–∏—Ç–æ–≥–æ –≤ –æ–¥–Ω–æ–π –∏–∑ –±–µ—Å–µ–¥! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å–æ —Å–ª–∏–≤–∞–º–∏ –∏ –ø—Ä–∏–º–∏—Ç–µ –º–µ—Ä—ã! \n
                    üíå ID –±–µ—Å–µ–¥—ã –≤ –∫–æ—Ç–æ—Ä–æ–π –æ—Å—Ç–∞–≤–∏–ª–∏: ${peerId}\n\n
                    üëâüèª vk.com/wall${t.group}_${t.post}
                    `,
                    keyboard: JSON.stringify({
                        inline: true,
                        buttons: [
                            [{ "action": { "type": "text", "label": `–†–∞–∑–±–∞–Ω–∏—Ç—å ${t.vk}` }, "color": "positive" },
                                { "action": { "type": "text", "label": `–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ${t.vk}` }, "color": "negative" }
                            ]
                        ]
                    })
                })

                return msg.send(`–•–æ—Ä–æ—à–æ, –º—ã –æ—Å—Ç–∞–≤–ª—è–µ–º –≤ –¥–∞–Ω–Ω–æ–π –±–µ—Å–µ–¥–µ @id${t.vk} ‚úÖ \n –¢–µ–ø–µ—Ä—å –µ–≥–æ –Ω–µ –∏—Å–∫–ª—é—á–∏—Ç —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ üë§`);
            } else {
                return msg.send(`–í—ã –Ω–µ –∞–¥–º–∏–Ω–∏—Å—Ç–∞—Ä—Ç–æ—Ä –≤ —ç—Ç–æ–π –±–µ—Å–µ–¥–µ, –ø–æ—ç—Ç–æ–º—É –Ω–µ –º–æ–∂–µ—Ç–µ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å`)
            }
        }

    })
});

updates.hear(/^(–∏—Å–∫–ª—é—á–∏—Ç—å)/ig, async(msg) => {
    if (!msg.chatId) return msg.send(`–ö–æ–≥–æ –∏—Å–∫–ª—é—á–∏—Ç—å —Ç–æ? –ö–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –±–µ—Å–µ–¥–µ üëÄ`);

    let peerId = Number(msg.peerId - 2000000000); // id –±–µ—Å–µ–¥—ã –≤ –∫–æ—Ç–æ—Ä–æ–π –≤—ã–∑–≤–∞–ª–∞—Å—å –∫–æ–º–∞–Ω–¥–∞
    page.api.messages.getConversationMembers({
        peer_id: 2000000000 + peerId,
        group_id: cgroup
    }).then(async function(a) {
        for (let i = 0; i < a.count; i++) {
            if (a.items[i].member_id == msg.senderId) { // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω –≤ –±–µ—Å–µ–¥–µ —Ç–æ —Ä–∞–±–æ—Ç–∞–µ–º –¥–∞–ª—å—à–µ
                if (!msg.params_org[0]) return msg.send(`–ü—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Å—Ç–∞–≤–∏—Ç—å`);
                let id = await vkId(msg.params_org[0], vk); // –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –∫–æ—Ç–æ—Ä–æ–≥–æ –≤–≤–µ–ª–∏
                let t = await user(id);

                // –∏—Å–∫–ª—é—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
                vk.api.messages.removeChatUser({
                    chat_id: peerId,
                    user_id: t.vk
                })

                // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –≥–ª–∞–≤–Ω—É—é –±–µ—Å–µ–¥—É:
                vk.api.messages.send({
                    chat_id: chatId,
                    message: `‚ö† @id${t.vk} –î–∞–Ω–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –∫–∏–∫–Ω—É–ª–∏ –∏–∑ –±–µ—Å–µ–¥—ã ‚Ññ${peerId} \n
                    –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç:
                    üëâüèª vk.com/wall${t.group}_${t.post}
                    `,
                    keyboard: JSON.stringify({
                        inline: true,
                        buttons: [
                            [{ "action": { "type": "text", "label": `–†–∞–∑–±–∞–Ω–∏—Ç—å ${t.vk}` }, "color": "positive" },
                                { "action": { "type": "text", "label": `–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ${t.vk}` }, "color": "negative" }
                            ]
                        ]
                    })
                })
            } else {
                return msg.send(`–í—ã –Ω–µ –∞–¥–º–∏–Ω–∏—Å—Ç–∞—Ä—Ç–æ—Ä –≤ —ç—Ç–æ–π –±–µ—Å–µ–¥–µ, –ø–æ—ç—Ç–æ–º—É –Ω–µ –º–æ–∂–µ—Ç–µ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å`)
            }
        }

    })
});

/*-------------------------------------------------------------------*/
/*     |                  –î–ª—è –∞–¥–º–∏–Ω–æ–≤ –±–æ—Ç–∞:                   
/*-------------------------------------------------------------------*/
updates.hear(/^(—Ä[–æ–∞][—Å–∑]–±–∞–Ω[–µ–∏]—Ç—å)/ig, async(msg) => {
    if (!admins.includes(msg.senderId)) return msg.send(`–¢—ã –Ω–µ –∞–¥–º–∏–Ω`);

    if (!msg.params_org[0]) return msg.send(`–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å —Å–ª–µ–¥—É—é—â–µ–π —Ñ–æ—Ä–º–æ–π:\n —Ä–∞–∑–±–∞–Ω–∏—Ç—å [—Å—Å—ã–ª–∫–∞/id] \n\n–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: \n —Ä–∞–∑–±–∞–Ω–∏—Ç—å https://vk.com/id0`)
    let rid = msg.params_org[0];
    let id = await vkId(rid, vk),
        t = await user(id);

    if (!t) return msg.send(`üïµ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω`);

    t.status = 2;

    return msg.send(`–í—ã —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ [id${t.vk}|–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è] ‚úÖ \n üìÉ –¢–µ–ø–µ—Ä—å –µ–≥–æ –Ω–µ –∏—Å–∫–ª—é—á–∞—Ç –≤ –Ω–∏–æ–¥–Ω–æ–π –∏–∑ –±–µ—Å–µ–¥`);
});

updates.hear(/^(–∑[–∞–æ]–±–ª[–∞–æ]–∫–∏—Ä[f–æ]–≤–∞—Ç—å)/ig, async(msg) => {
    if (!admins.includes(msg.senderId)) return msg.send(`–¢—ã –Ω–µ –∞–¥–º–∏–Ω`);

    if (!msg.params_org[0]) return msg.send(`–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å —Å–ª–µ–¥—É—é—â–µ–π —Ñ–æ—Ä–º–æ–π:\n –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å [—Å—Å—ã–ª–∫–∞/id] \n\n–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: \n –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å https://vk.com/id0`)
    let rid = msg.params_org[0];
    let id = await vkId(rid, vk),
        t = await user(id);

    if (!t) return msg.send(`üïµ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω`);

    t.status = 4;

    await msg.send(`–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ [id${t.vk}|–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è] ‚úÖ \n üìÉ –¢–µ–ø–µ—Ä—å –µ–≥–æ –∏—Å–∫–ª—é—á–∞—Ç —Å–æ –≤—Å–µ—Ö –±–µ—Å–µ–¥, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –æ—Å—Ç–∞–≤–∏–ª–∏ –¥–∞–Ω–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –≤ —Å–≤–æ–µ–π –±–µ—Å–µ–¥–µ `);
    return utils.checkConversations(page, vk, cgroup);
});

updates.hear(/^(test)/ig, async(msg) => {
    // cgroup = [185295814];
    utils.getFrauds(page, cgroup)
        // utils.checkConversations(page, vk, cgroup)

    // utils.sendRequest(msg, VK)
    // 3f25434da3d288039b91ee79b27236d328ab5c8a4604c6aaab5b0c959e3d93cebf416fcfb7a68b06e88fc
    msg.send(`good, –∑–∞–ø—É—Å—Ç–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É`)
});



// –æ—Å—Ç–∞–ª—å–Ω–æ–µ:
updates.hear(/^(?:[0-9]+)$/i, async(msg) => {

});

updates.hear(/(.*)/igm, async(msg) => { // –ù–∞–≤–∏–≥–∞—Ü–∏—è

});